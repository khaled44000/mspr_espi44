<!DOCTYPE html>
<script src="https://aframe.io/releases/0.8.2/aframe.min.js"></script>
<script src="//cdn.rawgit.com/donmccurdy/aframe-extras/v4.1.2/dist/aframe-extras.min.js"></script>
<script src="https://jeromeetienne.github.io/AR.js/aframe/build/aframe-ar.js"></script>
<body style='margin : 0px; overflow: hidden; font-family: Monospace;'>

	<div style='display: none; position: fixed; top: 10px; width:100%; text-align: center; z-index: 1;'>
		<a href="https://github.com/jeromeetienne/AR.js/" target="_blank">AR.js</a> - example for a-frame
        <br/>
        Contact me any time at <a href='https://twitter.com/jerome_etienne' target='_blank'>@Maehdi49</a>
	</div>
	<div id="markerVisible" style="position: fixed; top: 10px; left: 10px;">
		VISIBLE
	</div>
	<a-scene embedded arjs='trackingMethod: best; debugUIEnabled: false; 'id="gltfModel">
		<a-entity light="type: ambient; intensity: 4;"></a-entity>
		<a-marker id="marker-1" type='pattern' url='markers/1.patt'></a-marker>
		<a-marker id="marker-2" type='pattern' url='markers/2.patt'></a-marker>
		<a-gltf-model src="models/rino2.gltf" scale="0.5 0.5 0.5" position="0 0.75 0"  rotation="0 180 0" ></a-gltf-model>
		<a-camera-static />
	</a-scene>
		
	<script>
		const modelName = "models/rino2.gltf"
		const modelTexture = "textures/rino2.png"
		
		const scene = document.querySelector('a-scene')
		const model = document.querySelector('a-gltf-model')
		const markerVisible = document.getElementById("markerVisible")
		const markersNodes = document.querySelectorAll('a-marker')
		
		let markersValues = [false, false]
		
		const texture = new THREE.TextureLoader().load(modelTexture)
		texture.flipY = false; // for glTF models.

		model.addEventListener('model-loaded', e => {
		  e.detail.model.traverse( (node) => {
			if (node.isMesh) node.material.map = texture
		  })
		})
		
		scene.add(model)

		setInterval(() => console.log(model.position, model.object3D.position), 1000)

		function AreAllMarkersDetected(){
			const is = markersValues.every(m => m)
			if(is){
				let x = 0
				let y = 0
				let z = 0

				markersNodes.forEach((m,i) => {
					console.log(i, m.object3D.position)
					x += m.object3D.position.x
					y += m.object3D.position.y
					z += m.object3D.position.z
				})
				
				console.log({x: x / markersNodes.length, y: y / markersNodes.length, z: z / markersNodes.length})
				
				model.position = markersNodes[0].object3D.position
				model.object3D.position = markersNodes[0].object3D.position
				//model.position = {x: x / markersNodes.length, y: y / markersNodes.length, z: z / markersNodes.length}
				//model.object3D.position = {x: x / markersNodes.length, y: y / markersNodes.length, z: z / markersNodes.length}
			}
			return is
		}
		
		function updateMarkerStatus(node, status){
			const [, id] = (node.id || "").match(/^.*(\d+)$/) || [, -1]
			console.log(id, status)
			
			if(id !== -1 && id <= markersValues.length){
				markersValues[id - 1] = status
			}
			
			markerVisible.style.display = AreAllMarkersDetected() ? "block" : "none"
		}
				
		markersNodes.forEach(marker => {
			marker.addEventListener('markerFound', (e) => updateMarkerStatus(e.target, true))
			marker.addEventListener('markerLost', (e) => updateMarkerStatus(e.target, false))
		})
	</script>
</body>
</html>
